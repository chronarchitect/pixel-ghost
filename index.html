<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PixelGhost • EVA Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@600;800&family=Permanent+Marker&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0b12;          /* deep night */
      --panel:#101321;       /* card bg */
      --line:#21253a;        /* hairline */
      --purple:#5b2a86;      /* EVA-01 purple */
      --neon:#76ff03;        /* EVA lime */
      --warn:#ff7e00;        /* warning orange */
      --mag:#ff2fb9;         /* magenta accent */
      --fg:#e6ecf3;          /* text */
      --muted:#9aa6bd;
      --shadow:0 0 .5px rgba(118,255,3,.5), 0 0 16px rgba(118,255,3,.18), inset 0 0 0 1px rgba(118,255,3,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);font:14px "JetBrains Mono",ui-monospace,monospace;overflow-x:hidden;
      /* subtle scanlines + vignette */
      background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        radial-gradient(1200px 500px at 50% -200px, rgba(118,255,3,.08), transparent 60%);
      background-size:100% 22px, auto;
    }
    a{color:var(--neon);text-decoration:none}
    header{
      position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);
      background:linear-gradient(180deg, rgba(10,11,18,.9), rgba(10,11,18,.6));
      border-bottom:1px solid var(--line);
    }
    .bar{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:flex-end;justify-content:space-between}
    .brand{display:flex;align-items:flex-end;gap:.6rem}
    .pixel{font-family:"Orbitron",sans-serif;font-weight:800;letter-spacing:.08em;color:var(--neon);text-shadow:0 0 10px rgba(118,255,3,.5)}
    .ghost{font-family:"Permanent Marker",cursive;font-size:28px;color:var(--purple);transform:translateY(2px)}
    .tag{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.14em}

    main{max-width:1200px;margin:22px auto;padding:0 18px;display:grid;gap:18px;grid-template-columns: 1.1fr 1.9fr}
    @media (max-width: 980px){ main{grid-template-columns:1fr} }

    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;position:relative}
    .card:before{content:"";position:absolute;inset:-1px;border-radius:14px;pointer-events:none;box-shadow:var(--shadow);opacity:.55}
    .card h2{margin:0 0 8px 0;font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--neon)}
    .card p{margin:.25rem 0;color:var(--muted)}

    .btn{display:inline-flex;align-items:center;gap:.5rem;background:#171a2b;border:1px solid var(--line);color:var(--fg);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#2d3354;background:#1a1f36}
    .btn--primary{background:linear-gradient(180deg,#6b36a6,#532787);border-color:#6b36a6}
    .btn--primary:hover{filter:brightness(1.05)}

    /* form */
    .row{display:grid;gap:10px}
    input[type="file"], textarea, input[type="text"]{
      width:100%;background:#0c0f1f;border:1px solid var(--line);color:var(--fg);
      border-radius:10px;padding:10px 12px;font:inherit;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:var(--muted)}

    /* table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid #1a1e32}
    th{text-align:left;color:#b8c7f0;font-weight:600;font-size:12px;letter-spacing:.08em}
    tr:hover td{background:#13182a}
    .pill{padding:2px 8px;border-radius:999px;font-size:11px}
    .queued{background:#3a275f;color:#e3c8ff}
    .processing{background:#6b4a1a;color:#ffe3b5}
    .completed{background:#124e2a;color:#bff0cf}
    .failed{background:#5a1f2b;color:#ffd1d9}

    /* footer chart area */
    .full{grid-column:1/-1}

    /* decorative pixel ghost bg (canvas) */
    #bg{position:fixed;inset:0;z-index:-1;opacity:.18;}
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="pixel" style="font-size:20px">PIXEL</div>
        <div class="ghost">Ghost</div>
      </div>
      <div class="tag">eva-01 // ops console</div>
    </div>
  </header>

  <main>
    <!-- Submit / Lookup -->
    <section class="card">
      <h2>Submit Task</h2>
      <p>Encode text into image (LSB). Clean. Fast. Portable.</p>
      <div class="row" style="margin-top:10px">
        <input id="file" type="file" accept="image/*" />
        <textarea id="msg" placeholder="Your secret message…"></textarea>
        <button id="submit" class="btn btn--primary">Queue Task</button>
        <div id="out" class="hint"></div>
      </div>
      <hr style="border:none;border-top:1px solid var(--line);margin:16px 0" />
      <h2>Lookup</h2>
      <div class="row" style="grid-template-columns:1fr auto">
        <input id="lookup" type="text" placeholder="task-id" />
        <button id="check" class="btn">Check</button>
      </div>
      <div id="lookupOut" class="hint" style="margin-top:8px"></div>
    </section>

    <!-- Tasks table -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Tasks</h2>
        <button id="refresh" class="btn">Refresh</button>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Fn</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Started</th>
              <th>Dur</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Chart placeholder (you can wire later) -->
    <section class="card full">
      <h2>Throughput</h2>
      <p class="hint">Completed per minute — placeholder. Wire to your data when ready.</p>
      <div id="spark" style="height:110px;margin-top:6px;display:grid;grid-auto-flow:column;gap:6px;align-items:end"></div>
    </section>
  </main>

  <script>
    // ===== EVA pixel-ghost background (no libs): draw a pixel mask onto canvas
    const mask = [
      '....................',
      '......111111........',
      '.....11111111.......',
      '....1111111111......',
      '...111111111111.....',
      '..11111111111111....',
      '..11111111111111....',
      '..11111111111111....',
      '..11111..11..111....',
      '..1111..111..111....',
      '..11111111111111....',
      '..11111111111111....',
      '..11111..11..111....',
      '..1111....1..111....',
      '..111......1..11....',
      '....................'
    ];
    const bg = document.getElementById('bg');
    const g = bg.getContext('2d');
    function drawBG(){
      const w = bg.width = innerWidth * devicePixelRatio;
      const h = bg.height = innerHeight * devicePixelRatio;
      g.clearRect(0,0,w,h);
      const size = Math.min(w, h) * 0.02;
      const cols = mask[0].length, rows = mask.length;
      const startX = (w - cols*size)/2, startY = (h - rows*size)/2;
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          if(mask[y][x] === '1'){
            const xx = startX + x*size, yy = startY + y*size;
            const t = x/cols;
            const c1 = [0,234,255], c2 = [255,47,185]; // cyan -> magenta
            const c = [
              Math.round(c1[0] + (c2[0]-c1[0])*t),
              Math.round(c1[1] + (c2[1]-c1[1])*t),
              Math.round(c1[2] + (c2[2]-c1[2])*t)
            ];
            g.fillStyle = `rgba(${c[0]},${c[1]},${c[2]},.8)`;
            g.fillRect(xx, yy, size-2, size-2);
          }
        }
      }
      // eyes
      g.fillStyle = 'rgba(118,255,3,.9)';
      g.fillRect(startX + size*8.5, startY + size*6, size*1.6, size*1.6);
      g.fillRect(startX + size*11, startY + size*6, size*1.6, size*1.6);
    }
    drawBG(); addEventListener('resize', drawBG);

    // ===== API endpoints
    const API = 'http://localhost:8000';
    const ep = {
      submit: API + '/text/lsb/encode',
      list:   API + '/tasks',
      status: (id)=> API + '/task/status/' + id,
      result: (id)=> API + '/task/result/' + id
    }

    // ===== Submit
    const out = document.getElementById('out');
    document.getElementById('submit').onclick = async () => {
      const file = document.getElementById('file').files[0];
      const msg  = document.getElementById('msg').value.trim();
      if(!file || !msg){ out.textContent = 'Select an image and enter a message.'; return; }
      out.textContent = 'Submitting…';
      const fd = new FormData(); fd.append('image', file); fd.append('message', msg);
      try{
        const r = await fetch(ep.submit, { method:'POST', body: fd });
        const j = await r.json();
        if(!r.ok) throw new Error(JSON.stringify(j));
        out.innerHTML = `Queued ✔️ task_id: <code>${j.task_id}</code>`;
        loadTasks();
      }catch(e){ out.textContent = 'Error: ' + e; }
    }

    // ===== Lookup
    const lookupOut = document.getElementById('lookupOut');
    document.getElementById('check').onclick = async () =>{
      const id = document.getElementById('lookup').value.trim();
      if(!id) return; lookupOut.textContent = 'Checking…';
      try{
        const r = await fetch(ep.status(id)); const s = await r.json();
        if(!r.ok) throw new Error(JSON.stringify(s));
        lookupOut.textContent = 'Status: ' + s.status;
        if(s.status==='completed'){
          const res = await fetch(ep.result(id));
          if(res.headers.get('content-type')?.includes('application/json')){
            const data = await res.json(); lookupOut.textContent += ' • ' + JSON.stringify(data).slice(0,100)+'…';
          }else{
            const blob = await res.blob(); const url = URL.createObjectURL(blob);
            lookupOut.innerHTML += ` • <a href="${url}" download="pixelghost_${id}.png">Download</a>`
          }
        }
      }catch(e){ lookupOut.textContent = 'Error: ' + e }
    }

    // ===== Tasks table
    async function loadTasks(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '<tr><td colspan="6" style="padding:12px;color:#9aa6bd">Loading…</td></tr>';
      try{
        const r = await fetch(ep.list); const {tasks} = await r.json();
        tbody.innerHTML = '';
        (tasks||[]).forEach(t => {
          const dur = (t.finished_at && t.started_at) ? (t.finished_at - t.started_at).toFixed(2)+'s' : '';
          const tr = document.createElement('tr');
          const cls = t.status==='queued'?'queued':t.status==='processing'?'processing':t.status==='completed'?'completed':'failed';
          tr.innerHTML = `
            <td>${t.id.slice(0,8)}</td>
            <td>${t.fn_name}</td>
            <td>${t.priority}</td>
            <td><span class="pill ${cls}">${t.status}</span></td>
            <td>${t.started_at? new Date(t.started_at*1000).toLocaleTimeString():''}</td>
            <td>${dur}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" style="padding:12px;color:#ffb4c2">Failed to load: ${e}</td></tr>`
      }
    }
    document.getElementById('refresh').onclick = loadTasks;
    loadTasks();

    // ===== Minimal spark bar (placeholder numbers)
    const spark = document.getElementById('spark');
    function pushBar(v){
      const bar = document.createElement('div');
      bar.style.height = (8+v*10)+'px';
      bar.style.background = 'linear-gradient(180deg, '+(v>4?'#76ff03':'#ff7e00')+', transparent)';
      bar.style.border = '1px solid #233'; bar.style.borderRadius = '4px';
      spark.appendChild(bar);
      if(spark.children.length>80) spark.removeChild(spark.firstChild);
    }
    setInterval(()=> pushBar(Math.floor(Math.random()*7)), 1200);
  </script>
</body>
</html>
